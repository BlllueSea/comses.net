{% extends "sidebar_layout.jinja" %}
{% from "common.jinja" import breadcrumb, embed_discourse_comments, share_card, search_tag_href %}

{% macro member_href(member_profile) %}
    <a href="{{ member_profile.get_absolute_url() }}">{{ member_profile.name }}</a>
{% endmacro %}

{% set codebase = release.codebase %}

{% block title %}{{ codebase.title }}{% endblock %}

{% block introduction %}<h1>Computational Model Library</h1>{% endblock %}

{% block top %}
    {{ breadcrumb([
    {'url': url('library:codebase-list'), 'text': 'Computational Model Library' },
    {'text': codebase.title },
    {'text': release.version_number },
    ]) }}
{% endblock %}

{% block content %}
    <div id={{ 'discourse-content' if release.live else 'content' }}>
        {% if not release.live %}
            <div class="alert alert-danger mt-2">The release you are viewing is currently unpublished.
                {% if codebase.latest_version_number and version_number != codebase.latest_version_number %}
                    The latest published version is
                    <a href='{{ codebase.latest_version.get_absolute_url() }}'>{{ codebase.latest_version.version_number }}</a>
                {% endif %}
            </div>
        {% else %}
            {% if release.version_number != codebase.latest_version.version_number %}
                <div class="alert alert-warning mt-2">This release is out-of-date. The latest version is
                    <a href='{{ release.get_absolute_url() }}'>{{ codebase.latest_version.version_number }}</a>
                </div>
            {% endif %}
        {% endif %}
        <h1 class='codebase-title pb-4'>{{ codebase.title }}</h1>
        <div class='metadata'>
            <b>Submitted by:</b> {{ member_href(codebase.submitter.member_profile) }}
            <b class='pl-2'>Platform:</b>
            {% for p in release.platform_tags.all() %}
                {{ search_tag_href(p, category='codebases') }}
            {% else %}
                None
            {% endfor %}
            <b class='pl-2'>Version: </b> {{ release.version_number }}
            <b class='pl-2'>Language:</b>
            {% for pl in release.programming_languages.all() %}
                {{ search_tag_href(pl, category='codebases') }}
            {% endfor %}
        </div>
        <div class='tag-list'>
            {% for tag in codebase.tags.all() %}
                {{ search_tag_href(tag, category='codebases') }}
            {% endfor %}
        </div>
        <div class='pt-4'>
            <div class='lead'>
                {% autoescape false %}
                    {{ codebase.description }}
                {% endautoescape %}
            </div>
            <h3><u>Release Notes</u></h3>
            <div class='lead'>
                {% if release.release_notes %}
                    {% autoescape false %}
                        {{ release.release_notes }}
                    {% endautoescape %}
                {% else %}
                    No release notes were entered with this release.
                {% endif %}
            </div>
        </div>
    </div>
    <div class='card-metadata'>
        <div class='card-body'>
            <h2 class='card-title'>Cite this Model</h2>
            <div class='card-text'>
                {% if release.live %}
                    {{ release.citation_text|markdown }}
                {% elif has_change_perm %}
                    This model is currently <b>unpublished</b>.
                    <div class='input-group' id="regenerate_share_uuid"
                         data-absolute-url="{{ release.get_absolute_url() }}"
                         data-share-url="{{ request.build_absolute_uri(release.share_url) }}">
                        <div class='input-group-prepend'>
                            <span class='btn input-group-text'>
                                <i class='fa fa-retweet' @click="regenerateShareUuid"></i>
                            </span>
                        </div>
                        <input id='release-share-url' readonly class='form-control normal-readonly' :value="share_url">
                        <div class='input-group-append'>
                            <span class='btn btn-clipboard input-group-text' data-clipboard-target='#release-share-url'>
                                <i class='fa fa-copy'></i>
                            </span>
                        </div>
                    </div>
                    <small class='text-muted'>
                        Use this link to share this release privately with others. Anyone with this URL will be able to
                        access this release. Replace the private link with a new link by pressing
                        <span class="fa fa-retweet"></span>
                    </small>
                {% else %}
                    Hold on! This model is unpublished.
                    Perhaps the authors are not ready for it to be cited.
                {% endif %}
            </div>
        </div>
    </div>
    {% if codebase.replication %}
        <div class='card-metadata'>
            <div class='card-body'>
                <h2 class='card-title'>Replication of a previously published model</h2>
                <p class='card-text'>
                    {{ replication_text }}
                </p>
            </div>
        </div>
    {% endif %}
    {% if codebase.references_text %}
        <div class='card-metadata'>
            <div class='card-body'>
                <h2 class='card-title'>References</h2>
                <p class='card-text'>
                    {{ codebase.references_text }}
                </p>
            </div>
        </div>
    {% endif %}
    {% if codebase.associated_publication_text %}
        <div class='card-metadata'>
            <div class='card-body'>
                <h2 class='card-title'>Associated Publication</h2>
                <p class='card-text'>
                    {{ codebase.associated_publication_text }}
                </p>
            </div>
        </div>
    {% endif %}
    <ul class='nav nav-tabs detail-tabs' role='tablist'>
        <li class='nav-item'>
            <a class='nav-link active' data-toggle='tab' href='#images' role='tab'>Images</a>
        </li>
        <li class='nav-item'>
            <a class='nav-link' data-toggle='tab' href='#details' role='tab'>Details</a>
        </li>
        <li class='nav-item'>
            <a class='nav-link' data-toggle='tab' href='#versions' role='tab'>Versions</a>
        </li>
    </ul>
    <div class='tab-content'>
        <div class='tab-pane active' id='images' role='tabpanel'>
            {# FIXME: iterate and display all images in media #}
            <div class='p-3'>
                {% if codebase.get_featured_image() is not none %}
                    {{ image(codebase.get_featured_image(), "width-780", class='d-block img-fluid') }}
                {% else %}
                    <img src="holder.js/780x400?text=No uploaded images" class="img-fluid img-thumbnail">
                {% endif %}
            </div>
        </div>
        <div class='tab-pane' id='details' role='tabpanel'>
            <div class='card-metadata'>
                <div class='card-body'>
                    <div class='section'>
                        <b class='card-title'>Submitter:</b> {{ member_href(release.submitter.member_profile) }}
                    </div>
                    <div class='section'>
                        <b class='card-title'>DOI:</b> {{ release.doi }}
                    </div>
                    <div class='section'>
                        <b class='card-title'>License:</b> <a
                            href='{{ release.license.url }}'>{{ release.license.name }}</a>
                    </div>
                    <div class='section'>
                        <b class='card-title'>Operating System:</b> {{ operating_systems_enum[release.os] }}
                    </div>
                    <div class='section'>
                        <b class='card-title'>Programming Language:</b>
                        {% for pl in release.programming_languages.all() %}
                            {{ search_tag_href(pl, category='codebases') }}
                        {% endfor %}
                    </div>
                    <div class='section'>
                        <b class='card-title'>Dependencies:</b> {{ release.dependencies }}
                    </div>
                </div>
            </div>
        </div>
        <div class='tab-pane' id='versions' role='tabpanel'>
            <table class='table table-striped'>
                <thead>
                <tr>
                    <th>Version</th>
                    <th>Submitter</th>
                    <th>First published</th>
                    <th>Last modified</th>
                    {% if has_change_perm %}
                        <th>Status</th>
                        <th>Edit</th>
                    {% endif %}
                </tr>
                </thead>
                <tbody>
                {% for related_release in codebase.releases.all() %}
                    <tr>
                        <td><a href='{{ related_release.get_absolute_url() }}'>{{ related_release.version_number }}</a>
                        </td>
                        <td>{{ member_href(release.submitter.member_profile) }}</td>
                        <td>{{ release.first_published_at }}</td>
                        <td>{{ release.last_published_on }}</td>
                        {% if has_change_perm %}
                            <td>
                                {% if release.draft %}
                                    <span class="badge badge-danger">Draft</span>
                                {% elif release.live %}
                                    <span class="badge badge-success">Published</span>
                                {% else %}
                                    <span class="badge badge-warning">Unpublished</span>
                                {% endif %}
                            </td>
                            <td>
                                <a href="{{ release.get_edit_url() }}">
                                    <span class="fa fa-edit"></span>
                                </a>
                            </td>
                        {% endif %}
                    </tr>
                {% endfor %}
                </tbody>
            </table>
            <form>
                {% csrf_token %}
                {% if has_change_perm %}
                    <button class="btn btn-secondary" formmethod="post" formaction="{{ codebase.get_draft_url() }}">
                        Draft a new release
                    </button>
                {% endif %}
            </form>
        </div>
    </div>
    <hr>
    <h2 class='discourse-comments'>Discussion</h2>
    <div id='discourse-comments'>
        {% if not should_enable_discourse(release.live) %}
            Commenting is disabled. Due to liveness (live? {{ release.live }}) or environment ({{ deploy_environment() }}).
        {% endif %}
    </div>
{% endblock %}

{% block sidebar %}
<div class='card-metadata'>
    <div class='card-body'>
        <div class='section'>
            <b class="card-title">Authors</b>
            <p class='card-text'>
                {% for c in codebase.all_contributors %}
                    {% set badge_class='badge-success' if c.user else 'badge-default' %}
                    <a href='{{ c.get_profile_url() }}'>
                        <span class='badge {{ badge_class }}'>
                            {{ c.name }}
                        </span>
                    </a>
                {% endfor %}
            </p>
        </div>
        <div class='section'>
            <b class="card-title">Publish Date</b>
            <p class='card-text'>
                {{ release.first_published_at }}
            </p>
        </div>
        <div class='section'>
            <b class="card-title">Last Updated</b>
            <p class='card-text'>
                {{ release.last_published_on }}
            </p>
        </div>
        <div class='section'>
            <b class="card-title">Downloads: </b>{{ codebase.download_count() }}
        </div>
        <div class='section'>
            <b class="card-title">Status</b>
            <p class="card-text">
                {% if release.peer_reviewed %}
                    <img src="{{ static("images/icons/peer-reviewed.png") }}" alt="Peer Reviewed">
                {% elif has_review %}
                    Peer review underway
                {% else %}
                    Not reviewed
                {% endif %}
            </p>
        </div>
    </div>
</div>
{% if has_change_perm %}
    <form>
        {% csrf_token %}
        <button class="btn btn-secondary my-1 w-100" formmethod="post" formaction="{{ codebase.get_draft_url() }}">
            Draft a new release
        </button>
    </form>
    <a href="{{ release.get_edit_url() }}">
        <div class="btn btn-secondary my-1 w-100">Edit metadata</div>
    </a>
    {% set review_template_text -%}
    Request to review {{ request.build_absolute_uri(absolute_url) }}
    {%- endset %}
    {# FIXME: see https://github.com/comses/core.comses.net/issues/43 #}
    {% if release.get_review() is none %}
        <form method="post" action="{{ release.get_request_peer_review_url() }}">
            {% csrf_token %}
            <button type="submit" class='btn btn-secondary my-1 w-100'>
                Request peer review
            </button>
        </form>
    {% elif release.review.is_awaiting_author_changes %}
        <form method="post" action="{{ release.get_notify_reviewers_of_changes_url() }}">
        {% csrf_token %}
        <button type="submit" class="btn btn-danger my-1 w-100">Notify Reviewers of Changes</button>
        </form>
    {% else %}
        <button type="button" class="btn btn-warning my-1 w-100" disabled>{{ release.review.get_status_display() }}</button>
    {% endif %}
{% endif %}
{% if release.live %}
    <a id="releaseDownload" data-name="download" rel='nofollow' href="{{ release.get_download_url() }}">
        <button type="button" class="btn btn-primary my-1 w-100">Download</button>
    </a>
{% else %}
    <a rel='nofollow' href="{{ release.get_review_download_url() }}">
        <button type="button" class="btn btn-primary my-1 w-100">Download for Review</button>
    </a>
{% endif %}
{# FIXME: disabled for now <button type="button" class="btn btn-primary my-1 w-100">Follow</button>
    {{ share_card(absolute_url) }}
    #}
{% endblock %}

{% block js %}
    {# FIXME: remove this if there's a better way to include npm dependencies manually in a page #}
    {% with CLIPBOARD_JS_VERSION="2.0.0" %}
        <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/{{ CLIPBOARD_JS_VERSION }}/clipboard.min.js" async></script>
    {% endwith %}
    <script defer>
        new Clipboard('.btn-clipboard');
    </script>
    {{ render_bundle('release_regenerate_share_uuid', attrs='defer') }}
    {{ embed_discourse_comments(release.live, release.submitter.username) }}
{% endblock %}
