{% extends "sidebar_layout.jinja" %}
{% from "common.jinja" import breadcrumb, embed_discourse_comments, user_href %}

{% block title %}{{ title }}{% endblock %}

{% block introduction %}<h1>Computational Model Library</h1>{% endblock %}

{% block top %}
    {{ breadcrumb([
    {'url': url('library:codebase-list'), 'text': 'Computational Model Library' },
    {'text': title }
    ]) }}
{% endblock %}

{% block content %}
    <div id='discourse-content'>
        <h1 class="codebase-title pb-4">{{ title }}</h1>
        <div class='metadata'>
            <b>Submitted by:</b> {{ user_href(submitter) }}
            <b class='pl-2'>Platform:</b>
            {% for p in latest_version.platform_tags %}
                <a class='tag' href='/search?tag={{ p.name }}'>{{ p.name }}</a>
            {% endfor %}
            <b class='pl-2'>Version: </b> {{ latest_version.version_number }}
            <small><a href='{{ latest_version.absolute_url }}'>(View Latest)</a></small>
            <b class='pl-2'>Language:</b>
            {% for pl in latest_version.programming_languages %}
                <a class='tag' href='/search?tag={{ pl.name }}'>{{ pl.name }}</a>
            {% endfor %}
        </div>
        <div class='tags'>
            {% for tag in tags %}
                <a class='tag p-2' href='/search?tag={{ tag.name }}'>{{ tag.name }}</a>
            {% endfor %}
        </div>
        <div class='pt-4'>
            {{ description|markdown }}
        </div>
    </div>
    <div class='card-metadata'>
        <div class='card-block'>
            <h2 class='card-title'>Cite this Model</h2>
            <p class='card-text'>
                {{ latest_version.citation_text|markdown }}
            </p>
        </div>
    </div>
    {% if references_text %}
        <div class='card-metadata'>
            <div class='card-block'>
                <h2 class='card-title'>
                    {% if replication %}
                        This is a replication of a previously published model:
                    {% else %}
                        References:
                    {% endif %}
                </h2>
                <p class='card-text'>
                {{ references_text|markdown }}
                </p>
            </div>
        </div>
    {% endif %}
    {% if publication_text %}
        <div class='card-metadata'>
            <div class='card-block'>
                <h2 class='card-title'>Associated Publication</h2>
                <p class='card-text'>
                {{ publication_text|markdown }}
                </p>
            </div>
        </div>
    {% endif %}
    <ul class='nav nav-tabs codebase-tabs' role='tablist'>
        <li class='nav-item'>
            <a class='nav-link active' data-toggle='tab' href='#images' role='tab'>Images</a>
        </li>
        <li class='nav-item'>
            <a class='nav-link' data-toggle='tab' href='#details' role='tab'>Details</a>
        </li>
        <li class='nav-item'>
            <a class='nav-link' data-toggle='tab' href='#versions' role='tab'>Versions</a>
        </li>
    </ul>
    <div class='tab-content'>
        <div class='tab-pane active' id='images' role='tabpanel'>
            {# FIXME: iterate and display all images in media #}
            <div class='p-3'>
                {% if featured_image is not none %}
                    {{ image(featured_image, "width-780", class='d-block img-fluid') }}
                {% else %}
                    <img src="holder.js/780x400?text=No uploaded images" class="img-fluid img-thumbnail">
                {% endif %}
            </div>
        </div>
        <div class='tab-pane' id='details' role='tabpanel'>
            <div class='card-metadata'>
                <div class='card-block'>
                    <div class='section'>
                        <b class='card-title'>Submitter:</b> {{ user_href(submitter) }}
                    </div>
                    <div class='section'>
                        <b class='card-title'>DOI:</b> {{ doi }}
                    </div>
                    <div class='section'>
                        <b class='card-title'>License:</b> <a href='{{ latest_version.license.url }}'>{{ latest_version.license.name }}</a>
                    </div>
                    <div class='section'>
                        <b class='card-title'>Operating System:</b> {{ latest_version.get_os_display }}
                    </div>
                    <div class='section'>
                        <b class='card-title'>Dependencies:</b> {{ latest_version.dependencies }}
                    </div>
                </div>
            </div>
        </div>
        <div class='tab-pane' id='versions' role='tabpanel'>
            <table class='table table-striped'>
                <thead>
                    <tr>
                        <th>Version</th>
                        <th>Submitter</th>
                        <th>First published</th>
                        <th>Last modified</th>
                    </tr>
                </thead>
                <tbody>
                    {% for release in releases %}
                        <tr>
                            <td><a href='{{ release.absolute_url }}'>{{ release.version_number }}</a></td>
                            <td>{{ user_href(release.submitter) }}</td>
                            <td>{{ release.first_published_at }}</td>
                            <td>{{ release.last_published_on }}</td>
                        </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    <hr>
    <h2 class='discourse-comments'>Discussion</h2>
    <div id='discourse-comments'></div>
{% endblock %}

{% block sidebar %}
    <div class='card-metadata'>
        <div class='card-block'>
            <div class='section'>
                <b class="card-title">Authors</b>
                <p class='card-text'>
                {% for c in all_contributors %}
                    {% set badge_class='badge-success' if c.username else 'badge-default' %}
                    <a href='{{c.profile_url}}'>
                        <span class='badge {{badge_class}}'>
                            {{ c.name }}
                        </span>
                    </a>
                {% endfor %}
                </p>
            </div>
            <div class='section'>
                <b class="card-title">Publish Date</b>
                <p class='card-text'>
                {{ first_published_at }}
                </p>
            </div>
            <div class='section'>
                <b class="card-title">Last Updated</b>
                <p class='card-text'>
                {{ latest_version.last_published_on }}
                </p>
            </div>
            <div class='section'>
                <b class="card-title">Downloads: </b>{{ download_count }}
            </div>
            <div class='section'>
                <b class="card-title">Status</b>
                <p class="card-text">
                {% if peer_reviewed %}
                    <img src="{{ static("images/icons/peer-reviewed.png") }}" alt="Arizona State University">
                {% elif user == submitter %}
                    {# FIXME: check if user has permissions to request review, currently naive submitter check #}
                    <a class='btn btn-primary'>Request Review</a>
                {% else %}
                    Not reviewed
                {% endif %}
                </p>
            </div>
        </div>
    </div>
    <div class="card-metadata">
        <div class="card-block">
            <button type="button" class="col-12 my-1 btn btn-primary">Download</button>
            <button type="button" class="col-12 my-1 btn btn-primary">Follow</button>
        </div>
    </div>
    <div class="card-metadata">
        <div class="card-block my-auto">
            <ul class='social-media-sm my-auto'>
                <li class='pr-2'><b>Share</b></li>
                <li>
                    <a href='https://linkedin.com' title='LinkedIn' target='_blank'>
                        <span class='fa-stack'>
                            <i class='fa fa-circle fa-stack-2x'></i>
                            <i class='fa fa fa-linkedin fa-inverse fa-stack-1x'></i>
                        </span>
                    </a>
                </li>
                <li>
                    <a href='https://facebook.com' title='facebook' target='_blank'>
                        <span class='fa-stack'>
                            <i class='fa fa-circle fa-stack-2x'></i>
                            <i class='fa fa-facebook fa-inverse fa-stack-1x'></i>
                        </span>
                    </a>
                </li>
                <li>
                    <a href='https://twitter.com' title='Twitter' target='_blank'>
                        <span class='fa-stack'>
                            <i class='fa fa-circle fa-stack-2x'></i>
                            <i class='fa fa-twitter fa-inverse fa-stack-1x'></i>
                        </span>
                    </a>
                </li>
                <li>
                    <a href='#' title='Email'>
                        <span class='fa-stack'>
                            <i class='fa fa-circle fa-stack-2x'></i>
                            <i class='fa fa-envelope fa-inverse fa-stack-1x'></i>
                        </span>
                    </a>
                </li>
            </ul>
        </div>
    </div>
{% endblock %}

{% block js %}
    {{ embed_discourse_comments(live) }}
{% endblock %}
