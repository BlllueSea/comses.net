{% extends "sidebar_layout.jinja" %}
{% from "common.jinja" import breadcrumb, embed_discourse_comments, member_profile_href, share_card, search_tag_href %}

{% block title %}{{ title }}{% endblock %}

{% block introduction %}<h1>Computational Model Library</h1>{% endblock %}

{% block top %}
    {{ breadcrumb([
    {'url': url('library:codebase-list'), 'text': 'Computational Model Library' },
    {'text': title }
    ]) }}
{% endblock %}

{% block content %}
    <div id='discourse-content'>
        <h1 class="codebase-title pb-4">{{ title }}</h1>
        <div class='metadata'>
            <b>Submitted by:</b> {{ member_profile_href(submitter) }}
            <b class='pl-2'>Platform:</b>
            {% for p in current_version.platform_tags %}
                {{ search_tag_href(p) }}
            {% else %}
                None
            {% endfor %}
            <b class='pl-2'>Version: </b> {{ current_version.version_number }}
            <b class='pl-2'>Language:</b>
            {% for pl in current_version.programming_languages %}
                {{ search_tag_href(pl) }}
            {% endfor %}
        </div>
        <div class='tag-list'>
            {% for tag in tags %}
                {{ search_tag_href(tag) }}
            {% endfor %}
        </div>
        <div class='pt-4'>
            {{ description|markdown }}
        </div>
    </div>
    <div class='card-metadata'>
        <div class='card-body'>
            <h2 class='card-title'>Cite this Model</h2>
            <p class='card-text'>
                {{ current_version.citation_text|markdown }}
            </p>
        </div>
    </div>
    {% if references_text %}
        <div class='card-metadata'>
            <div class='card-body'>
                <h2 class='card-title'>
                    {% if replication %}
                        This is a replication of a previously published model:
                    {% else %}
                        References:
                    {% endif %}
                </h2>
                <p class='card-text'>
                {{ references_text|markdown }}
                </p>
            </div>
        </div>
    {% endif %}
    {% if associated_publication_text %}
        <div class='card-metadata'>
            <div class='card-body'>
                <h2 class='card-title'>Associated Publication</h2>
                <p class='card-text'>
                {{ associated_publication_text|markdown }}
                </p>
            </div>
        </div>
    {% endif %}
    <ul class='nav nav-tabs detail-tabs' role='tablist'>
        <li class='nav-item'>
            <a class='nav-link active' data-toggle='tab' href='#images' role='tab'>Images</a>
        </li>
        <li class='nav-item'>
            <a class='nav-link' data-toggle='tab' href='#details' role='tab'>Details</a>
        </li>
        <li class='nav-item'>
            <a class='nav-link' data-toggle='tab' href='#versions' role='tab'>Versions</a>
        </li>
    </ul>
    <div class='tab-content'>
        <div class='tab-pane active' id='images' role='tabpanel'>
            {# FIXME: iterate and display all images in media #}
            <div class='p-3'>
                {% if featured_image is not none %}
                    {{ image(featured_image, "width-780", class='d-block img-fluid') }}
                {% else %}
                    <img src="holder.js/780x400?text=No uploaded images" class="img-fluid img-thumbnail">
                {% endif %}
            </div>
        </div>
        <div class='tab-pane' id='details' role='tabpanel'>
            <div class='card-metadata'>
                <div class='card-body'>
                    <div class='section'>
                        <b class='card-title'>Submitter:</b> {{ member_profile_href(submitter) }}
                    </div>
                    <div class='section'>
                        <b class='card-title'>DOI:</b> {{ doi }}
                    </div>
                    <div class='section'>
                        <b class='card-title'>License:</b> <a href='{{ current_version.license.url }}'>{{ current_version.license.name }}</a>
                    </div>
                    <div class='section'>
                        <b class='card-title'>Operating System:</b> {{ current_version.os_display }}
                    </div>
                    <div class='section'>
                        <b class='card-title'>Programming Language:</b>
                        {% for pl in current_version.programming_languages %}
                            {{ search_tag_href(pl) }}
                        {% endfor %}
                    </div>
                    <div class='section'>
                        <b class='card-title'>Dependencies:</b> {{ current_version.dependencies }}
                    </div>
                </div>
            </div>
        </div>
        <div class='tab-pane' id='versions' role='tabpanel'>
            <table class='table table-striped'>
                <thead>
                    <tr>
                        <th>Version</th>
                        <th>Submitter</th>
                        <th>First published</th>
                        <th>Last modified</th>
                    </tr>
                </thead>
                <tbody>
                    {% for release in releases %}
                        <tr>
                            <td><a href='{{ release.absolute_url }}'>{{ release.version_number }}</a></td>
                            <td>{{ member_profile_href(release.submitter) }}</td>
                            <td>{{ release.first_published_at }}</td>
                            <td>{{ release.last_published_on }}</td>
                        </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    <hr>
    <h2 class='discourse-comments'>Discussion</h2>
    <div id='discourse-comments'></div>
{% endblock %}

{% block sidebar %}
    <div class='card-metadata'>
        <div class='card-body'>
            <div class='section'>
                <b class="card-title">Authors</b>
                <p class='card-text'>
                {% for c in all_contributors %}
                    {% set badge_class='badge-success' if c.contributor.user else 'badge-default' %}
                    <a href='{{c.profile_url}}'>
                        <span class='badge {{badge_class}}'>
                            {{ c.contributor.name }}
                        </span>
                    </a>
                {% endfor %}
                </p>
            </div>
            <div class='section'>
                <b class="card-title">Publish Date</b>
                <p class='card-text'>
                {{ first_published_at }}
                </p>
            </div>
            <div class='section'>
                <b class="card-title">Last Updated</b>
                <p class='card-text'>
                {{ current_version.last_published_on }}
                </p>
            </div>
            <div class='section'>
                <b class="card-title">Downloads: </b>{{ download_count }}
            </div>
            <div class='section'>
                <b class="card-title">Status</b>
                <p class="card-text">
                {% if peer_reviewed %}
                    <img src="{{ static("images/icons/peer-reviewed.png") }}" alt="Arizona State University">
                {% elif user == submitter %}
                    {# FIXME: check if user has permissions to request review, currently naive submitter check #}
                    <a class='btn btn-primary'>Request Review</a>
                {% else %}
                    Not reviewed
                {% endif %}
                </p>
            </div>
        </div>
    </div>
    <div class="card-metadata">
        <div class="card-body">
            {% if has_change_perm %}
                <a href="{{ url('library:codebase-edit', identifier=identifier) }}" class="col-12 my-1 btn btn-primary">Edit</a>
            {% endif %}
            <button type="button" class="col-12 my-1 btn btn-primary">Download</button>
            <button type="button" class="col-12 my-1 btn btn-primary">Follow</button>
        </div>
    </div>
    {{ share_card(absolute_url) }}
{% endblock %}

{% block js %}
    {{ embed_discourse_comments(live) }}
{% endblock %}
