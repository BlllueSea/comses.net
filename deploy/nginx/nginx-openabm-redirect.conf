worker_processes auto;
user        root;
pid         /var/run/nginx.pid;
error_log   /var/log/nginx/error.log;

events {
    worker_connections 1024;
    accept_mutex off;
}

http {
    include mime.types;
    default_type application/octet-stream;
    access_log  /var/log/nginx/access.log combined;
    sendfile off;
    keepalive_timeout 65;

    server {
        listen      80;
        server_name openabm.org;
        return      301 $scheme://www.comses.net;
    }

    map $request_uri $openabm_redirect_uri {
        ~*/models?/?$                               https://www.comses.net/codebases/;
        ~*/model/(?<identifier>\d+)/?$              https://www.comses.net/codebases/$identifier/;
        ~*/(education|tutorials)/?$                 https://www.comses.net/resources/education/;
        ~*/resources/?$                             https://www.comses.net/resources/;
        ~*/(platforms|modeling-platforms)           https://www.comses.net/resources/modeling-platforms/;
        ~*/event*                                   https://www.comses.net/events/calendar/;
        ~*/forum/jobs-and-appointments*             https://www.comses.net/jobs/;
        ~*/jobs*                                    https://www.comses.net/jobs/;
        ~*/forum*                                   https://forum.comses.net/;
        ~*/(standards|odd)/?$                       https://www.comses.net/resources/standards/;
        ~*/model/(?<id>\d+)/version/(?<ver>\d+)$    https://www.comses.net/codebases/$id/version/$ver/;
    }

    server {
        listen      80;
        client_max_body_size    75M;
        server_name www.openabm.org;

        if ( $openabm_redirect_uri ) {
            return 301 $openabm_redirect_uri;
        }
        return 301 https://www.comses.net;
        access_log /var/log/nginx/access.log;
        error_log /var/log/nginx/error.log;
    }

}
