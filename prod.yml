services:
  elasticsearch:
    restart: always
    networks:
      - esnet
    environment:
      - bootstrap.memory_lock=true
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
      - esdata1:/usr/share/elasticsearch/data
# FIXME: duplication bad
  elasticsearch2:
    image: docker.elastic.co/elasticsearch/elasticsearch:${ES_VERSION}
    restart: always
    networks:
      - esnet
    environment:
      - bootstrap.memory_lock=true
      - node.name=esnode2
      - discovery.seed_hosts=elasticsearch
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    deploy:
      resources:
        limits:
          memory: 1g
    cap_add:
      - IPC_LOCK
    volumes:
      - ./deploy/elasticsearch.conf.d/elasticsearch-node.yml:/usr/share/elasticsearch/config/elasticsearch.yml
      - ./deploy/elasticsearch.conf.d/log4j2.properties:/usr/share/elasticsearch/config/log4j2.properties
      - esdata2:/usr/share/elasticsearch/data
  db:
    image: postgis/postgis:15-3.3
    restart: always
    networks:
      - db
    volumes:
      - ./docker/shared/pgdata:/var/lib/postgresql/data
  js:
    # FIXME: currently needs a second Django `./manage.py collectstatic` to move generated assets from Django into
    # static directory, seems we should be able to skip that step
    build: frontend
    image: comses/cmsjs:${RELEASE_VERSION}
    command: ['yarn', 'build']
    environment:
      NODE_ENV: "production"
    volumes:
      - ./frontend/src:/code/src
      - ./frontend/yarn.lock:/code/yarn.lock
      - ./docker/shared:/shared
      - ./deploy/conf/config.ini:/secrets/config.ini
  nginx:
    image: nginx:stable
    restart: always
    volumes:
      - ./deploy/nginx/nginx-haproxy.conf:/etc/nginx/nginx.conf
      - ./deploy/nginx/uwsgi_params:/etc/nginx/uwsgi_params
      - ./deploy/nginx/well-known:/srv/.well-known
      - ./docker/shared/logs/nginx:/var/log/nginx
      - ./docker/shared/static:/srv/static
      - ./docker/shared/media:/srv/media
      - ./docker/shared/library:/library
      - sockets:/shared/sockets
    command: ["nginx", "-g", "daemon off;"]
    networks:
      - cms
    ports:
      - "80:80"
    depends_on:
      - cms
  cms:
    build:
      context: ./django
      args:
        REQUIREMENTS_FILE: requirements.txt
        UBUNTU_MIRROR: "mirror.it.ubc.ca"
        RUN_SCRIPT: "./deploy/prod.sh"
    image: comses/cms:${RELEASE_VERSION}
    restart: always
    networks:
      - cms
      - esnet
      - db
    volumes:
      - ./deploy/conf/config.ini:/secrets/config.ini
      - ./deploy/elasticsearch.conf.d:/etc/elasticsearch
      - ./docker/shared:/shared
      - sockets:/shared/sockets
    environment:
      DJANGO_SETTINGS_MODULE: "core.settings.production"
    ports:
      - "127.0.0.1:9191:9191" # uWSGI stats server
    depends_on:
      - db
      - elasticsearch
      - redis
networks:
  esnet:
    driver: bridge
  cms:
    driver: bridge
  db:
    driver: bridge
volumes:
  sockets:
    driver: local
  esdata1:
    driver: local
  esdata2:
    driver: local
